name: Update README Wallpaper Preview

on:
  push:
    paths:
      - "Wallpapers/**"
      - "README.md"

permissions:
  contents: write

jobs:
  update-preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate preview HTML
        run: |
          echo "<table>" > preview.html
          count=0

          for img in Wallpapers/*.jpg Wallpapers/*.jpeg Wallpapers/*.png; do
            [ -e "$img" ] || continue

            if [ $((count % 3)) -eq 0 ]; then
              echo "<tr>" >> preview.html
            fi

            echo "<td align=\"center\">
            <a href=\"$img\">
              <img src=\"$img\" width=\"300\">
            </a>
            </td>" >> preview.html

            if [ $((count % 3)) -eq 2 ]; then
              echo "</tr>" >> preview.html
            fi

            count=$((count + 1))
          done

          echo "</table>" >> preview.html

      - name: Update README
        run: |
          awk '
          BEGIN {found=0}
          /<!-- WALLPAPER_PREVIEW_START -->/ {
            print;
            system("cat preview.html");
            found=1;
            next
          }
          /<!-- WALLPAPER_PREVIEW_END -->/ {
            found=0;
            print;
            next
          }
          !found {print}
          ' README.md > README.tmp

          mv README.tmp README.md

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "ci: update wallpaper preview" || exit 0
          git push

